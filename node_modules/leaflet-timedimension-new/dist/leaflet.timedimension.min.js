/* 
 * Leaflet TimeDimension v1.1.0 - 2019-08-31 
 * 
 * Copyright 2019 Biel Frontera (ICTS SOCIB) 
 * datacenter@socib.es 
 * http://www.socib.es/ 
 * 
 * Licensed under the MIT license. 
 * 
 * Demos: 
 * http://apps.socib.es/Leaflet.TimeDimension/ 
 * 
 * Source: 
 * git://github.com/socib/Leaflet.TimeDimension.git 
 * 
 */

!function(e,i){if("function"==typeof define&&define.amd)define(["leaflet","iso8601-js-period"],e);else if("object"==typeof exports)module.exports=e(require("leaflet"),require("iso8601-js-period"));else if(void 0!==i&&i.L&&"undefined"!=typeof L){var t=nezasa.iso8601;i.L.TimeDimension=e(L,t)}}(function(l,e){if(void 0===i)var i={iso8601:e};return l.TimeDimension=(l.Layer||l.Class).extend({includes:l.Evented||l.Mixin.Events,initialize:function(e){l.setOptions(this,e),this._availableTimes=this._generateAvailableTimes(),this._currentTimeIndex=-1,this._loadingTimeIndex=-1,this._loadingTimeout=this.options.loadingTimeout||3e3,this._syncedLayers=[],0<this._availableTimes.length&&this.setCurrentTime(this.options.currentTime||this._getDefaultCurrentTime()),this.options.lowerLimitTime&&this.setLowerLimit(this.options.lowerLimitTime),this.options.upperLimitTime&&this.setUpperLimit(this.options.upperLimitTime)},getAvailableTimes:function(){return this._availableTimes},getCurrentTimeIndex:function(){return-1===this._currentTimeIndex?this._availableTimes.length-1:this._currentTimeIndex},getCurrentTime:function(){var e=-1;return 0<=(e=-1!==this._loadingTimeIndex?this._loadingTimeIndex:this.getCurrentTimeIndex())?this._availableTimes[e]:null},isLoading:function(){return-1!==this._loadingTimeIndex},setCurrentTimeIndex:function(e){var i=this._upperLimit||this._availableTimes.length-1,t=this._lowerLimit||0;if(!((e=Math.min(Math.max(t,e),i))<0)){this._loadingTimeIndex=e;var s=this._availableTimes[e];this._checkSyncedLayersReady(this._availableTimes[this._loadingTimeIndex])?this._newTimeIndexLoaded():(this.fire("timeloading",{time:s}),setTimeout(function(e){e==this._loadingTimeIndex&&this._newTimeIndexLoaded()}.bind(this,e),this._loadingTimeout))}},_newTimeIndexLoaded:function(){if(-1!==this._loadingTimeIndex){var e=this._availableTimes[this._loadingTimeIndex];this._currentTimeIndex=this._loadingTimeIndex,this.fire("timeload",{time:e}),this._loadingTimeIndex=-1}},_checkSyncedLayersReady:function(e){for(var i=0,t=this._syncedLayers.length;i<t;i++)if(this._syncedLayers[i].isReady&&!this._syncedLayers[i].isReady(e))return!1;return!0},setCurrentTime:function(e){var i=this._seekNearestTimeIndex(e);this.setCurrentTimeIndex(i)},seekNearestTime:function(e){var i=this._seekNearestTimeIndex(e);return this._availableTimes[i]},nextTime:function(e,i){e=e||1;var t=this._currentTimeIndex,s=this._upperLimit||this._availableTimes.length-1,n=this._lowerLimit||0;-1<this._loadingTimeIndex&&(t=this._loadingTimeIndex),s<(t+=e)&&(t=i?n:s),t<n&&(t=i?s:n),this.setCurrentTimeIndex(t)},prepareNextTimes:function(e,i,t){e=e||1;var s=this._currentTimeIndex,n=s;-1<this._loadingTimeIndex&&(s=this._loadingTimeIndex);for(var a=0,o=this._syncedLayers.length;a<o;a++)this._syncedLayers[a].setMinimumForwardCache&&this._syncedLayers[a].setMinimumForwardCache(i);for(var r=i,h=this._upperLimit||this._availableTimes.length-1,l=this._lowerLimit||0;0<r;){if(h<(s+=e)){if(!t)break;s=l}if(s<l){if(!t)break;s=h}if(n===s)break;this.fire("timeloading",{time:this._availableTimes[s]}),r--}},getNumberNextTimesReady:function(e,i,t){e=e||1;var s=this._currentTimeIndex;-1<this._loadingTimeIndex&&(s=this._loadingTimeIndex);for(var n=i,a=0,o=this._upperLimit||this._availableTimes.length-1,r=this._lowerLimit||0;0<n;){if(o<(s+=e)){if(!t){n=0,a=i;break}s=r}if(s<r){if(!t){n=0,a=i;break}s=o}var h=this._availableTimes[s];this._checkSyncedLayersReady(h)&&a++,n--}return a},previousTime:function(e,i){this.nextTime(-1*e,i)},registerSyncedLayer:function(e){this._syncedLayers.push(e),e.on("timeload",this._onSyncedLayerLoaded,this)},unregisterSyncedLayer:function(e){var i=this._syncedLayers.indexOf(e);-1!=i&&this._syncedLayers.splice(i,1),e.off("timeload",this._onSyncedLayerLoaded,this)},_onSyncedLayerLoaded:function(e){e.time==this._availableTimes[this._loadingTimeIndex]&&this._checkSyncedLayersReady(e.time)&&this._newTimeIndexLoaded()},_generateAvailableTimes:function(){if(this.options.times)return l.TimeDimension.Util.parseTimesExpression(this.options.times);if(this.options.timeInterval){var e=l.TimeDimension.Util.parseTimeInterval(this.options.timeInterval),i=this.options.period||"P1D",t=this.options.validTimeRange||void 0;return l.TimeDimension.Util.explodeTimeRange(e[0],e[1],i,t)}return[]},_getDefaultCurrentTime:function(){var e=this._seekNearestTimeIndex((new Date).getTime());return this._availableTimes[e]},_seekNearestTimeIndex:function(e){for(var i=0,t=this._availableTimes.length;i<t&&!(e<this._availableTimes[i]);i++);return 0<i&&i--,i},setAvailableTimes:function(e,i){var t=this.getCurrentTime(),s=this.getLowerLimit(),n=this.getUpperLimit();if("extremes"==i){var a=this.options.period||"P1D";this._availableTimes=l.TimeDimension.Util.explodeTimeRange(new Date(e[0]),new Date(e[e.length-1]),a)}else{var o=l.TimeDimension.Util.parseTimesExpression(e);if(0===this._availableTimes.length)this._availableTimes=o;else if("intersect"==i)this._availableTimes=l.TimeDimension.Util.intersect_arrays(o,this._availableTimes);else if("union"==i)this._availableTimes=l.TimeDimension.Util.union_arrays(o,this._availableTimes);else{if("replace"!=i)throw"Merge available times mode not implemented: "+i;this._availableTimes=o}}s&&this.setLowerLimit(s),n&&this.setUpperLimit(n),this.setCurrentTime(t),this.fire("availabletimeschanged",{availableTimes:this._availableTimes,currentTime:t})},getLowerLimit:function(){return this._availableTimes[this.getLowerLimitIndex()]},getUpperLimit:function(){return this._availableTimes[this.getUpperLimitIndex()]},setLowerLimit:function(e){var i=this._seekNearestTimeIndex(e);this.setLowerLimitIndex(i)},setUpperLimit:function(e){var i=this._seekNearestTimeIndex(e);this.setUpperLimitIndex(i)},setLowerLimitIndex:function(e){this._lowerLimit=Math.min(Math.max(e||0,0),this._upperLimit||this._availableTimes.length-1),this.fire("limitschanged",{lowerLimit:this._lowerLimit,upperLimit:this._upperLimit})},setUpperLimitIndex:function(e){this._upperLimit=Math.max(Math.min(e,this._availableTimes.length-1),this._lowerLimit||0),this.fire("limitschanged",{lowerLimit:this._lowerLimit,upperLimit:this._upperLimit})},getLowerLimitIndex:function(){return this._lowerLimit},getUpperLimitIndex:function(){return this._upperLimit}}),l.Map.addInitHook(function(){this.options.timeDimension&&(this.timeDimension=l.timeDimension(this.options.timeDimensionOptions||{}))}),l.timeDimension=function(e){return new l.TimeDimension(e)},l.TimeDimension.Util={getTimeDuration:function(e){if(void 0===i)throw"iso8601-js-period library is required for Leatlet.TimeDimension: https://github.com/nezasa/iso8601-js-period";return i.iso8601.Period.parse(e,!0)},addTimeDuration:function(e,i,t){void 0===t&&(t=!0),("string"==typeof i||i instanceof String)&&(i=this.getTimeDuration(i));var s=i.length,n=t?"getUTC":"get",a=t?"setUTC":"set";0<s&&0!=i[0]&&e[a+"FullYear"](e[n+"FullYear"]()+i[0]),1<s&&0!=i[1]&&e[a+"Month"](e[n+"Month"]()+i[1]),2<s&&0!=i[2]&&e[a+"Date"](e[n+"Date"]()+7*i[2]),3<s&&0!=i[3]&&e[a+"Date"](e[n+"Date"]()+i[3]),4<s&&0!=i[4]&&e[a+"Hours"](e[n+"Hours"]()+i[4]),5<s&&0!=i[5]&&e[a+"Minutes"](e[n+"Minutes"]()+i[5]),6<s&&0!=i[6]&&e[a+"Seconds"](e[n+"Seconds"]()+i[6])},subtractTimeDuration:function(e,i,t){("string"==typeof i||i instanceof String)&&(i=this.getTimeDuration(i));for(var s=[],n=0,a=i.length;n<a;n++)s.push(-i[n]);this.addTimeDuration(e,s,t)},parseAndExplodeTimeRange:function(e){var i=e.split("/"),t=new Date(Date.parse(i[0])),s=new Date(Date.parse(i[1])),n=2<i.length?i[2]:"P1D";return this.explodeTimeRange(t,s,n)},explodeTimeRange:function(e,i,t,s){var n=this.getTimeDuration(t),a=[],o=new Date(e.getTime()),r=null,h=null,l=null,m=null;if(void 0!==s){var u=s.split("/");r=u[0].split(":")[0],h=u[0].split(":")[1],l=u[1].split(":")[0],m=u[1].split(":")[1]}for(;o<i;)(void 0===s||o.getUTCHours()>=r&&o.getUTCHours()<=l)&&(o.getUTCHours()!=r||o.getUTCMinutes()>=h)&&(o.getUTCHours()!=l||o.getUTCMinutes()<=m)&&a.push(o.getTime()),this.addTimeDuration(o,n);return i<=o&&a.push(i.getTime()),a},parseTimeInterval:function(e){var i=e.split("/");if(2!=i.length)throw"Incorrect ISO9601 TimeInterval: "+e;var t=Date.parse(i[0]),s=null,n=null;return isNaN(t)?(n=this.getTimeDuration(i[0]),s=Date.parse(i[1]),t=new Date(s),this.subtractTimeDuration(t,n,!0),s=new Date(s)):(s=Date.parse(i[1]),isNaN(s)?(n=this.getTimeDuration(i[1]),s=new Date(t),this.addTimeDuration(s,n,!0)):s=new Date(s),t=new Date(t)),[t,s]},parseTimesExpression:function(e){var i=[];if(!e)return i;if("string"==typeof e||e instanceof String)for(var t,s,n=e.split(","),a=0,o=n.length;a<o;a++)3==(t=n[a]).split("/").length?i=i.concat(this.parseAndExplodeTimeRange(t)):(s=Date.parse(t),isNaN(s)||i.push(s));else i=e;return i.sort(function(e,i){return e-i})},intersect_arrays:function(e,i){for(var t=e.slice(0),s=i.slice(0),n=[];0<t.length&&0<s.length;)t[0]<s[0]?t.shift():(t[0]>s[0]||n.push(t.shift()),s.shift());return n},union_arrays:function(e,i){for(var t=e.slice(0),s=i.slice(0),n=[];0<t.length&&0<s.length;)t[0]<s[0]?n.push(t.shift()):t[0]>s[0]?n.push(s.shift()):(n.push(t.shift()),s.shift());return 0<t.length?n=n.concat(t):0<s.length&&(n=n.concat(s)),n},sort_and_deduplicate:function(e){for(var i=[],t=null,s=0,n=(e=e.slice(0).sort()).length;s<n;s++)e[s]!==t&&(i.push(e[s]),t=e[s]);return i}},l.TimeDimension.Layer=(l.Layer||l.Class).extend({includes:l.Evented||l.Mixin.Events,options:{opacity:1,zIndex:1},initialize:function(e,i){l.setOptions(this,i||{}),this._map=null,this._baseLayer=e,this._currentLayer=null,this._timeDimension=this.options.timeDimension||null},addTo:function(e){return e.addLayer(this),this},onAdd:function(e){this._map=e,!this._timeDimension&&e.timeDimension&&(this._timeDimension=e.timeDimension),this._timeDimension.on("timeloading",this._onNewTimeLoading,this),this._timeDimension.on("timeload",this._update,this),this._timeDimension.registerSyncedLayer(this),this._update()},onRemove:function(e){this._timeDimension.unregisterSyncedLayer(this),this._timeDimension.off("timeloading",this._onNewTimeLoading,this),this._timeDimension.off("timeload",this._update,this),this.eachLayer(e.removeLayer,e),this._map=null},eachLayer:function(e,i){return e.call(i,this._baseLayer),this},setZIndex:function(e){return this.options.zIndex=e,this._baseLayer.setZIndex&&this._baseLayer.setZIndex(e),this._currentLayer&&this._currentLayer.setZIndex&&this._currentLayer.setZIndex(e),this},setOpacity:function(e){return this.options.opacity=e,this._baseLayer.setOpacity&&this._baseLayer.setOpacity(e),this._currentLayer&&this._currentLayer.setOpacity&&this._currentLayer.setOpacity(e),this},bringToBack:function(){if(this._currentLayer)return this._currentLayer.bringToBack(),this},bringToFront:function(){if(this._currentLayer)return this._currentLayer.bringToFront(),this},_onNewTimeLoading:function(e){this.fire("timeload",{time:e.time})},isReady:function(e){return!0},_update:function(){return!0},getBaseLayer:function(){return this._baseLayer},getBounds:function(){var e=new l.LatLngBounds;return this._currentLayer&&e.extend(this._currentLayer.getBounds?this._currentLayer.getBounds():this._currentLayer.getLatLng()),e}}),l.timeDimension.layer=function(e,i){return new l.TimeDimension.Layer(e,i)},l.TimeDimension.Layer.WMS=l.TimeDimension.Layer.extend({initialize:function(e,i){l.TimeDimension.Layer.prototype.initialize.call(this,e,i),this._timeCacheBackward=this.options.cacheBackward||this.options.cache||0,this._timeCacheForward=this.options.cacheForward||this.options.cache||0,this._wmsVersion=this.options.wmsVersion||this.options.version||e.options.version||"1.1.1",this._getCapabilitiesParams=this.options.getCapabilitiesParams||{},this._getCapabilitiesAlternateUrl=this.options.getCapabilitiesUrl||null,this._getCapabilitiesAlternateLayerName=this.options.getCapabilitiesLayerName||null,this._proxy=this.options.proxy||null,this._updateTimeDimension=this.options.updateTimeDimension||!1,this._setDefaultTime=this.options.setDefaultTime||!1,this._updateTimeDimensionMode=this.options.updateTimeDimensionMode||"intersect",this._layers={},this._defaultTime=0,this._availableTimes=[],this._capabilitiesRequested=!1,(this._updateTimeDimension||this.options.requestTimeFromCapabilities)&&this._requestTimeDimensionFromCapabilities(),this._baseLayer.on("load",function(){this._baseLayer.setLoaded(!0),this.fire("timeload",{time:this._defaultTime})}.bind(this))},getEvents:function(){var e=l.bind(this._unvalidateCache,this);return{moveend:e,zoomend:e}},eachLayer:function(e,i){for(var t in this._layers)this._layers.hasOwnProperty(t)&&e.call(i,this._layers[t]);return l.TimeDimension.Layer.prototype.eachLayer.call(this,e,i)},_onNewTimeLoading:function(e){var i=this._getLayerForTime(e.time);this._map.hasLayer(i)||this._map.addLayer(i)},isReady:function(e){var i=this._getLayerForTime(e);return!(!this.options.bounds||!this._map||this._map.getBounds().contains(this.options.bounds))||i.isLoaded()},onAdd:function(e){l.TimeDimension.Layer.prototype.onAdd.call(this,e),0==this._availableTimes.length?this._requestTimeDimensionFromCapabilities():this._updateTimeDimensionAvailableTimes()},_update:function(){if(this._map){var e=this._timeDimension.getCurrentTime(),i=this._getLayerForTime(e);null==this._currentLayer&&(this._currentLayer=i),this._map.hasLayer(i)?this._showLayer(i,e):this._map.addLayer(i)}},setOpacity:function(e){for(var i in l.TimeDimension.Layer.prototype.setOpacity.apply(this,arguments),this._layers)this._layers.hasOwnProperty(i)&&this._layers[i].setOpacity&&this._layers[i].setOpacity(e)},setZIndex:function(e){for(var i in l.TimeDimension.Layer.prototype.setZIndex.apply(this,arguments),this._layers)this._layers.hasOwnProperty(i)&&this._layers[i].setZIndex&&this._layers[i].setZIndex(e)},setParams:function(e,i){for(var t in l.extend(this._baseLayer.options,e),this._baseLayer.setParams&&this._baseLayer.setParams(e,i),this._layers)this._layers.hasOwnProperty(t)&&this._layers[t].setParams&&(this._layers[t].setLoaded(!1),this._layers[t].setParams(e,i));return this},_unvalidateCache:function(){var e=this._timeDimension.getCurrentTime();for(var i in this._layers)e!=i&&this._layers.hasOwnProperty(i)&&(this._layers[i].setLoaded(!1),this._layers[i].redraw())},_evictCachedTimes:function(e,i){var t,s=this._getLoadedTimes(),n=String(this._currentTime),a=s.indexOf(n),o=[];-1<i&&0<(t=a-i)&&(o=s.splice(0,t),this._removeLayers(o));-1<e&&(a=s.indexOf(n),0<(t=s.length-a-e-1)&&(o=s.splice(a+e+1,t),this._removeLayers(o)))},_showLayer:function(e,i){this._currentLayer&&this._currentLayer!==e&&this._currentLayer.hide(),e.show(),this._currentLayer&&this._currentLayer===e||(this._currentLayer=e,this._currentTime=i,this._evictCachedTimes(this._timeCacheForward,this._timeCacheBackward))},_getLayerForTime:function(e){if(0==e||e==this._defaultTime||null==e)return this._baseLayer;if(this._layers.hasOwnProperty(e))return this._layers[e];var i=this._getNearestTime(e);if(this._layers.hasOwnProperty(i))return this._layers[i];var t=this._createLayerForTime(i);return(this._layers[e]=t).on("load",function(e,i){e.setLoaded(!0),this._layers[i]||(this._layers[i]=e),this._timeDimension&&i==this._timeDimension.getCurrentTime()&&!this._timeDimension.isLoading()&&this._showLayer(e,i),this.fire("timeload",{time:i})}.bind(this,t,e)),t.onAdd=function(e){Object.getPrototypeOf(this).onAdd.call(this,e),this.hide()}.bind(t),t},_createLayerForTime:function(e){var i=this._baseLayer.options;return i.time=new Date(e).toISOString(),new this._baseLayer.constructor(this._baseLayer.getURL(),i)},_getLoadedTimes:function(){var e=[];for(var i in this._layers)this._layers.hasOwnProperty(i)&&e.push(i);return e.sort(function(e,i){return e-i})},_removeLayers:function(e){for(var i=0,t=e.length;i<t;i++)this._map&&this._map.removeLayer(this._layers[e[i]]),delete this._layers[e[i]]},setMinimumForwardCache:function(e){e>this._timeCacheForward&&(this._timeCacheForward=e)},_requestTimeDimensionFromCapabilities:function(){if(!this._capabilitiesRequested){this._capabilitiesRequested=!0;var e=this._getCapabilitiesUrl();this._proxy&&(e=this._proxy+"?url="+encodeURIComponent(e));var i=new XMLHttpRequest;i.addEventListener("load",function(e){var i=e.currentTarget.responseXML;this._defaultTime=Date.parse(this._getDefaultTimeFromCapabilities(i)),this._setDefaultTime=this._setDefaultTime||this._timeDimension&&0==this._timeDimension.getAvailableTimes().length,this.setAvailableTimes(this._parseTimeDimensionFromCapabilities(i)),this._setDefaultTime&&this._timeDimension&&this._timeDimension.setCurrentTime(this._defaultTime)}.bind(this)),i.overrideMimeType("application/xml"),i.open("GET",e),i.send()}},_getCapabilitiesUrl:function(){var e=this._baseLayer.getURL();this._getCapabilitiesAlternateUrl&&(e=this._getCapabilitiesAlternateUrl);var i=l.extend({},this._getCapabilitiesParams,{request:"GetCapabilities",service:"WMS",version:this._wmsVersion});return e+=l.Util.getParamString(i,e,i.uppercase)},_parseTimeDimensionFromCapabilities:function(e){var i=e.querySelectorAll('Layer[queryable="1"]'),t=this._baseLayer.wmsParams.layers,s=null,n=null;return i.forEach(function(e){e.querySelector("Name").innerHTML===t&&(s=e)}),s&&(n=(n=this._getTimesFromLayerCapabilities(s))||this._getTimesFromLayerCapabilities(s.parentNode)),n},_getTimesFromLayerCapabilities:function(e){var i=null,t=e.querySelectorAll("Dimension[name='time']");if(t&&t.length&&t[0].textContent.length)i=t[0].textContent.trim();else{var s=e.querySelectorAll("Extent[name='time']");s&&s.length&&s[0].textContent.length&&(i=s[0].textContent.trim())}return i},_getDefaultTimeFromCapabilities:function(e){var i=e.querySelectorAll('Layer[queryable="1"]'),t=this._baseLayer.wmsParams.layers,s=null;i.forEach(function(e){e.querySelector("Name").innerHTML===t&&(s=e)});var n=0;return s&&0==(n=this._getDefaultTimeFromLayerCapabilities(s))&&(n=this._getDefaultTimeFromLayerCapabilities(s.parentNode)),n},_getDefaultTimeFromLayerCapabilities:function(e){var i=0,t=e.querySelectorAll("Dimension[name='time']");if(t&&t.length&&t[0].attributes.default)i=t[0].attributes.default;else{var s=e.querySelectorAll("Extent[name='time']");s&&s.length&&s[0].attributes.default&&(i=s[0].attributes.default)}return i},setAvailableTimes:function(e){this._availableTimes=l.TimeDimension.Util.parseTimesExpression(e),this._updateTimeDimensionAvailableTimes()},_updateTimeDimensionAvailableTimes:function(){(this._timeDimension&&this._updateTimeDimension||this._timeDimension&&0==this._timeDimension.getAvailableTimes().length)&&(this._timeDimension.setAvailableTimes(this._availableTimes,this._updateTimeDimensionMode),this._setDefaultTime&&0<this._defaultTime&&this._timeDimension.setCurrentTime(this._defaultTime))},_getNearestTime:function(e){if(this._layers.hasOwnProperty(e))return e;if(0==this._availableTimes.length)return e;for(var i=0,t=this._availableTimes.length;i<t&&!(e<this._availableTimes[i]);i++);return 0<i&&i--,this._availableTimes[i],this._availableTimes[i]}}),l.NonTiledLayer||(l.NonTiledLayer=(l.Layer||l.Class).extend({})),l.NonTiledLayer.include({_visible:!0,_loaded:!1,_originalUpdate:l.NonTiledLayer.prototype._update,_originalOnRemove:l.NonTiledLayer.prototype.onRemove,_update:function(){!this._visible&&this._loaded||this._originalUpdate()},onRemove:function(e){this._loaded=!1,this._originalOnRemove(e)},setLoaded:function(e){this._loaded=e},isLoaded:function(){return this._loaded},hide:function(){this._visible=!1,this._div.style.display="none"},show:function(){this._visible=!0,this._div.style.display="block"},getURL:function(){return this._wmsUrl}}),l.TileLayer.include({_visible:!0,_loaded:!1,_originalUpdate:l.TileLayer.prototype._update,_update:function(){!this._visible&&this._loaded||this._originalUpdate()},setLoaded:function(e){this._loaded=e},isLoaded:function(){return this._loaded},hide:function(){this._visible=!1,this._container&&(this._container.style.display="none")},show:function(){this._visible=!0,this._container&&(this._container.style.display="block")},getURL:function(){return this._url}}),l.timeDimension.layer.wms=function(e,i){return new l.TimeDimension.Layer.WMS(e,i)},l.TimeDimension.Layer.GeoJson=l.TimeDimension.Layer.extend({initialize:function(e,i){l.TimeDimension.Layer.prototype.initialize.call(this,e,i),this._updateTimeDimension=this.options.updateTimeDimension||!1,this._updateTimeDimensionMode=this.options.updateTimeDimensionMode||"extremes",this._duration=this.options.duration||null,this._addlastPoint=this.options.addlastPoint||!1,this._waitForReady=this.options.waitForReady||!1,this._defaultTime=0,this._availableTimes=[],this._loaded=!1,0==this._baseLayer.getLayers().length?this._waitForReady?this._baseLayer.on("ready",this._onReadyBaseLayer,this):this._loaded=!0:(this._loaded=!0,this._setAvailableTimes()),this._baseLayer.on("layeradd",function(){this._loaded&&this._setAvailableTimes()}.bind(this))},onAdd:function(e){l.TimeDimension.Layer.prototype.onAdd.call(this,e),this._loaded&&this._setAvailableTimes()},eachLayer:function(e,i){return this._currentLayer&&e.call(i,this._currentLayer),l.TimeDimension.Layer.prototype.eachLayer.call(this,e,i)},isReady:function(e){return this._loaded},_update:function(){if(this._map&&this._loaded){this._timeDimension.getCurrentTime();var e=this._timeDimension.getCurrentTime(),i=0;if(this._duration){var t=new Date(e);l.TimeDimension.Util.subtractTimeDuration(t,this._duration,!0),i=t.getTime()}for(var s=l.geoJson(null,this._baseLayer.options),n=this._baseLayer.getLayers(),a=0,o=n.length;a<o;a++){var r=this._getFeatureBetweenDates(n[a].feature,i,e);if(r&&(s.addData(r),this._addlastPoint&&"LineString"==r.geometry.type&&0<r.geometry.coordinates.length)){var h=r.properties;h.last=!0,s.addData({type:"Feature",properties:h,geometry:{type:"Point",coordinates:r.geometry.coordinates[r.geometry.coordinates.length-1]}})}}this._currentLayer&&this._map.removeLayer(this._currentLayer),s.getLayers().length&&(s.addTo(this._map),this._currentLayer=s)}},_setAvailableTimes:function(){for(var e=[],i=this._baseLayer.getLayers(),t=0,s=i.length;t<s;t++)if(i[t].feature)for(var n=this._getFeatureTimes(i[t].feature),a=0,o=n.length;a<o;a++)e.push(n[a]);this._availableTimes=l.TimeDimension.Util.sort_and_deduplicate(e),this._timeDimension&&(this._updateTimeDimension||0==this._timeDimension.getAvailableTimes().length)&&this._timeDimension.setAvailableTimes(this._availableTimes,this._updateTimeDimensionMode)},_getFeatureTimes:function(e){if(!e.featureTimes){e.properties?e.properties.hasOwnProperty("coordTimes")?e.featureTimes=e.properties.coordTimes:e.properties.hasOwnProperty("times")?e.featureTimes=e.properties.times:e.properties.hasOwnProperty("linestringTimestamps")?e.featureTimes=e.properties.linestringTimestamps:e.properties.hasOwnProperty("time")?e.featureTimes=[e.properties.time]:e.featureTimes=[]:e.featureTimes=[];for(var i=0,t=e.featureTimes.length;i<t;i++){var s=e.featureTimes[i];("string"==typeof s||s instanceof String)&&(s=Date.parse(s.trim()),e.featureTimes[i]=s)}}return e.featureTimes},_getFeatureBetweenDates:function(e,i,t){var s=this._getFeatureTimes(e);if(0==s.length)return e;var n=null,a=null,o=s.length;if(s[0]>t||s[o-1]<i)return null;if(s[o-1]>i)for(var r=0;r<o;r++)if(null===n&&s[r]>i&&(n=r),s[r]>t){a=r;break}null===n&&(n=0),null===a&&(a=o);var h=[];return h=e.geometry.coordinates[0].length?e.geometry.coordinates.slice(n,a):e.geometry.coordinates,{type:"Feature",properties:e.properties,geometry:{type:e.geometry.type,coordinates:h}}},_onReadyBaseLayer:function(){this._loaded=!0,this._setAvailableTimes(),this._update()}}),l.timeDimension.layer.geoJson=function(e,i){return new l.TimeDimension.Layer.GeoJson(e,i)},l.TimeDimension.Player=(l.Layer||l.Class).extend({includes:l.Evented||l.Mixin.Events,initialize:function(e,i){l.setOptions(this,e),this._timeDimension=i,this._paused=!1,this._buffer=this.options.buffer||5,this._minBufferReady=this.options.minBufferReady||1,this._waitingForBuffer=!1,this._loop=this.options.loop||!1,this._steps=1,this._timeDimension.on("timeload",function(e){this.release(),this._waitingForBuffer=!1}.bind(this)),this.setTransitionTime(this.options.transitionTime||1e3),this._timeDimension.on("limitschanged availabletimeschanged timeload",function(e){this._timeDimension.prepareNextTimes(this._steps,this._minBufferReady,this._loop)}.bind(this))},_tick:function(){var e=this._getMaxIndex(),i=this._timeDimension.getCurrentTimeIndex()>=e&&0<this._steps,t=0==this._timeDimension.getCurrentTimeIndex()&&this._steps<0;if((i||t)&&!this._loop)return this.pause(),this.stop(),void this.fire("animationfinished");if(!this._paused){var s=0,n=this._bufferSize;if(0<this._minBufferReady)if(s=this._timeDimension.getNumberNextTimesReady(this._steps,n,this._loop),this._waitingForBuffer){if(s<n)return void this.fire("waiting",{buffer:n,available:s});this.fire("running"),this._waitingForBuffer=!1}else if(s<this._minBufferReady)return this._waitingForBuffer=!0,this._timeDimension.prepareNextTimes(this._steps,n,this._loop),void this.fire("waiting",{buffer:n,available:s});this.pause(),this._timeDimension.nextTime(this._steps,this._loop),0<n&&this._timeDimension.prepareNextTimes(this._steps,n,this._loop)}},_getMaxIndex:function(){return Math.min(this._timeDimension.getAvailableTimes().length-1,this._timeDimension.getUpperLimitIndex()||1/0)},start:function(e){this._intervalID||(this._steps=e||1,this._waitingForBuffer=!1,this.options.startOver&&this._timeDimension.getCurrentTimeIndex()===this._getMaxIndex()&&this._timeDimension.setCurrentTimeIndex(this._timeDimension.getLowerLimitIndex()||0),this.release(),this._intervalID=window.setInterval(l.bind(this._tick,this),this._transitionTime),this._tick(),this.fire("play"),this.fire("running"))},stop:function(){this._intervalID&&(clearInterval(this._intervalID),this._intervalID=null,this._waitingForBuffer=!1,this.fire("stop"))},pause:function(){this._paused=!0},release:function(){this._paused=!1},getTransitionTime:function(){return this._transitionTime},isPlaying:function(){return!!this._intervalID},isWaiting:function(){return this._waitingForBuffer},isLooped:function(){return this._loop},setLooped:function(e){this._loop=e,this.fire("loopchange",{loop:e})},setTransitionTime:function(e){this._transitionTime=e,"function"==typeof this._buffer?this._bufferSize=this._buffer.call(this,this._transitionTime,this._minBufferReady,this._loop):this._bufferSize=this._buffer,this._intervalID&&(this.stop(),this.start(this._steps)),this.fire("speedchange",{transitionTime:e,buffer:this._bufferSize})},getSteps:function(){return this._steps}}),l.UI=l.ui=l.UI||{},l.UI.Knob=l.Draggable.extend({options:{className:"knob",step:1,rangeMin:0,rangeMax:10},initialize:function(e,i){l.setOptions(this,i),this._element=l.DomUtil.create("div",this.options.className||"knob",e),l.Draggable.prototype.initialize.call(this,this._element,this._element),this._container=e,this.on("predrag",function(){this._newPos.y=0,this._newPos.x=this._adjustX(this._newPos.x)},this),this.on("dragstart",function(){l.DomUtil.addClass(e,"dragging")}),this.on("dragend",function(){l.DomUtil.removeClass(e,"dragging")}),l.DomEvent.on(this._element,"dblclick",function(e){this.fire("dblclick",e)},this),l.DomEvent.disableClickPropagation(this._element),this.enable()},_getProjectionCoef:function(){return(this.options.rangeMax-this.options.rangeMin)/(this._container.offsetWidth||this._container.style.width)},_update:function(){this.setPosition(l.DomUtil.getPosition(this._element).x)},_adjustX:function(e){var i=this._toValue(e)||this.getMinValue();return this._toX(this._adjustValue(i))},_adjustValue:function(e){return e=Math.max(this.getMinValue(),Math.min(this.getMaxValue(),e)),e-=this.options.rangeMin,e=Math.round(e/this.options.step)*this.options.step,e+=this.options.rangeMin,e=Math.round(100*e)/100},_toX:function(e){return(e-this.options.rangeMin)/this._getProjectionCoef()},_toValue:function(e){return e*this._getProjectionCoef()+this.options.rangeMin},getMinValue:function(){return this.options.minValue||this.options.rangeMin},getMaxValue:function(){return this.options.maxValue||this.options.rangeMax},setStep:function(e){this.options.step=e,this._update()},setPosition:function(e){l.DomUtil.setPosition(this._element,l.point(this._adjustX(e),0)),this.fire("positionchanged")},getPosition:function(){return l.DomUtil.getPosition(this._element).x},setValue:function(e){this.setPosition(this._toX(e))},getValue:function(){return this._adjustValue(this._toValue(this.getPosition()))}}),l.Control.TimeDimension=l.Control.extend({options:{styleNS:"leaflet-control-timecontrol",position:"bottomleft",title:"Time Control",backwardButton:!0,forwardButton:!0,playButton:!0,playReverseButton:!1,loopButton:!1,displayDate:!0,timeSlider:!0,timeSliderDragUpdate:!1,limitSliders:!1,limitMinimumRange:5,speedSlider:!0,minSpeed:.1,maxSpeed:10,speedStep:.1,timeSteps:1,autoPlay:!1,playerOptions:{transitionTime:1e3},timeZones:["UTC","Local"],speedSliderMultiple:[]},initialize:function(e){l.Control.prototype.initialize.call(this,e),this._timeZoneIndex=0,this._timeDimension=this.options.timeDimension||null},onAdd:function(e){var i;return this._map=e,!this._timeDimension&&e.timeDimension&&(this._timeDimension=e.timeDimension),this._initPlayer(),i=l.DomUtil.create("div","leaflet-bar leaflet-bar-horizontal leaflet-bar-timecontrol"),this.options.loopButton&&(this._buttonLoop=this._createButton("Loop",i)),this.options.displayDate&&(this._displayDate=this._createButton("Date",i)),this.options.timeSlider&&(this._sliderTime=this._createSliderTime(this.options.styleNS+" timecontrol-slider timecontrol-dateslider",i)),this.options.backwardButton&&(this._buttonBackward=this._createButton("Backward",i)),this.options.playReverseButton&&(this._buttonPlayReversePause=this._createButton("Play Reverse",i)),this.options.playButton&&(this._buttonPlayPause=this._createButton("Play",i)),this.options.forwardButton&&(this._buttonForward=this._createButton("Forward",i)),this.options.speedSlider?this._sliderSpeed=this._createSliderSpeed(this.options.styleNS+" timecontrol-slider timecontrol-speed",i):this.options.speedSliderMultiple.length&&(this._sliderSpeed=this._createSpeedMultiple(this.options.styleNS+" timecontrol-slider",i,this.options.speedSliderMultiple)),this._steps=this.options.timeSteps||1,this._timeDimension.on("timeload",this._update,this),this._timeDimension.on("timeload",this._onPlayerStateChange,this),this._timeDimension.on("timeloading",this._onTimeLoading,this),this._timeDimension.on("limitschanged availabletimeschanged",this._onTimeLimitsChanged,this),l.DomEvent.disableClickPropagation(i),i},addTo:function(){return l.Control.prototype.addTo.apply(this,arguments),this._onPlayerStateChange(),this._onTimeLimitsChanged(),this._update(),this},onRemove:function(){this._player.off("play stop running loopchange speedchange",this._onPlayerStateChange,this),this._player.off("waiting",this._onPlayerWaiting,this),this._timeDimension.off("timeload",this._update,this),this._timeDimension.off("timeload",this._onPlayerStateChange,this),this._timeDimension.off("timeloading",this._onTimeLoading,this),this._timeDimension.off("limitschanged availabletimeschanged",this._onTimeLimitsChanged,this)},_initPlayer:function(){this._player||(this.options.player?this._player=this.options.player:this._player=new l.TimeDimension.Player(this.options.playerOptions,this._timeDimension)),this.options.autoPlay&&this._player.start(this._steps),this._player.on("play stop running loopchange speedchange",this._onPlayerStateChange,this),this._player.on("waiting",this._onPlayerWaiting,this),this._onPlayerStateChange()},_onTimeLoading:function(e){e.time==this._timeDimension.getCurrentTime()&&this._displayDate&&l.DomUtil.addClass(this._displayDate,"loading")},_onTimeLimitsChanged:function(){var e=this._timeDimension.getLowerLimitIndex(),i=this._timeDimension.getUpperLimitIndex(),t=this._timeDimension.getAvailableTimes().length-1;this._limitKnobs&&(this._limitKnobs[0].options.rangeMax=t,this._limitKnobs[1].options.rangeMax=t,this._limitKnobs[0].setValue(e||0),this._limitKnobs[1].setValue(i||t)),this._sliderTime&&(this._sliderTime.options.rangeMax=t,this._sliderTime._update())},_onPlayerWaiting:function(e){this._buttonPlayPause&&0<this._player.getSteps()&&(l.DomUtil.addClass(this._buttonPlayPause,"loading"),this._buttonPlayPause.innerHTML=this._getDisplayLoadingText(e.available,e.buffer)),this._buttonPlayReversePause&&this._player.getSteps()<0&&(l.DomUtil.addClass(this._buttonPlayReversePause,"loading"),this._buttonPlayReversePause.innerHTML=this._getDisplayLoadingText(e.available,e.buffer))},_onPlayerStateChange:function(){if(this._buttonPlayPause&&(this._player.isPlaying()&&0<this._player.getSteps()?(l.DomUtil.addClass(this._buttonPlayPause,"pause"),l.DomUtil.removeClass(this._buttonPlayPause,"play")):(l.DomUtil.removeClass(this._buttonPlayPause,"pause"),l.DomUtil.addClass(this._buttonPlayPause,"play")),this._player.isWaiting()&&0<this._player.getSteps()?l.DomUtil.addClass(this._buttonPlayPause,"loading"):(this._buttonPlayPause.innerHTML="",l.DomUtil.removeClass(this._buttonPlayPause,"loading"))),this._buttonPlayReversePause&&(this._player.isPlaying()&&this._player.getSteps()<0?l.DomUtil.addClass(this._buttonPlayReversePause,"pause"):l.DomUtil.removeClass(this._buttonPlayReversePause,"pause"),this._player.isWaiting()&&this._player.getSteps()<0?l.DomUtil.addClass(this._buttonPlayReversePause,"loading"):(this._buttonPlayReversePause.innerHTML="",l.DomUtil.removeClass(this._buttonPlayReversePause,"loading"))),this._buttonLoop&&(this._player.isLooped()?l.DomUtil.addClass(this._buttonLoop,"looped"):l.DomUtil.removeClass(this._buttonLoop,"looped")),this._sliderSpeed&&!this._draggingSpeed){var e=this._player.getTransitionTime()||1e3;e=Math.round(1e4/e)/10,this._sliderSpeed.setValue(e)}},_update:function(){if(this._timeDimension)if(0<=this._timeDimension.getCurrentTimeIndex()){var e=new Date(this._timeDimension.getCurrentTime());this._displayDate&&(l.DomUtil.removeClass(this._displayDate,"loading"),this._displayDate.innerHTML=this._getDisplayDateFormat(e)),this._sliderTime&&!this._slidingTimeSlider&&this._sliderTime.setValue(this._timeDimension.getCurrentTimeIndex())}else this._displayDate&&(this._displayDate.innerHTML=this._getDisplayNoTimeError())},_createButton:function(e,i){var t=l.DomUtil.create("a",this.options.styleNS+" timecontrol-"+e.toLowerCase(),i);return t.href="#",t.title=e,l.DomEvent.addListener(t,"click",l.DomEvent.stopPropagation).addListener(t,"click",l.DomEvent.preventDefault).addListener(t,"click",this["_button"+e.replace(/ /i,"")+"Clicked"],this),t},_createSliderTime:function(e,i){var t,s,n,a,o;return t=l.DomUtil.create("div",e,i),s=l.DomUtil.create("div","slider",t),n=this._timeDimension.getAvailableTimes().length-1,this.options.limitSliders&&(o=this._limitKnobs=this._createLimitKnobs(s)),(a=new l.UI.Knob(s,{className:"knob main",rangeMin:0,rangeMax:n})).on("dragend",function(e){var i=e.target.getValue();this._sliderTimeValueChanged(i),this._slidingTimeSlider=!1},this),a.on("drag",function(e){this._slidingTimeSlider=!0;var i=this._timeDimension.getAvailableTimes()[e.target.getValue()];if(i){var t=new Date(i);this._displayDate&&(this._displayDate.innerHTML=this._getDisplayDateFormat(t)),this.options.timeSliderDragUpdate&&this._sliderTimeValueChanged(e.target.getValue())}},this),a.on("predrag",function(){var e,i;o&&(e=o[0].getPosition(),i=o[1].getPosition(),this._newPos.x<e&&(this._newPos.x=e),this._newPos.x>i&&(this._newPos.x=i))},a),l.DomEvent.on(s,"click",function(e){if(!l.DomUtil.hasClass(e.target,"knob")){var i=e.touches&&1===e.touches.length?e.touches[0]:e,t=l.DomEvent.getMousePosition(i,s).x;o?o[0].getPosition()<=t&&t<=o[1].getPosition()&&(a.setPosition(t),this._sliderTimeValueChanged(a.getValue())):(a.setPosition(t),this._sliderTimeValueChanged(a.getValue()))}},this),a.setPosition(0),a},_createLimitKnobs:function(e){l.DomUtil.addClass(e,"has-limits");var i=this._timeDimension.getAvailableTimes().length-1,t=l.DomUtil.create("div","range",e),s=new l.UI.Knob(e,{className:"knob lower",rangeMin:0,rangeMax:i}),n=new l.UI.Knob(e,{className:"knob upper",rangeMin:0,rangeMax:i});return l.DomUtil.setPosition(t,0),s.setPosition(0),n.setPosition(i),s.on("dragend",function(e){var i=e.target.getValue();this._sliderLimitsValueChanged(i,n.getValue())},this),n.on("dragend",function(e){var i=e.target.getValue();this._sliderLimitsValueChanged(s.getValue(),i)},this),s.on("drag positionchanged",function(){l.DomUtil.setPosition(t,l.point(s.getPosition(),0)),t.style.width=n.getPosition()-s.getPosition()+"px"},this),n.on("drag positionchanged",function(){t.style.width=n.getPosition()-s.getPosition()+"px"},this),n.on("predrag",function(){var e=s._toX(s.getValue()+this.options.limitMinimumRange);n._newPos.x<=e&&(n._newPos.x=e)},this),s.on("predrag",function(){var e=n._toX(n.getValue()-this.options.limitMinimumRange);s._newPos.x>=e&&(s._newPos.x=e)},this),s.on("dblclick",function(){this._timeDimension.setLowerLimitIndex(0)},this),n.on("dblclick",function(){this._timeDimension.setUpperLimitIndex(this._timeDimension.getAvailableTimes().length-1)},this),[s,n]},_createSliderSpeed:function(e,i){var t=l.DomUtil.create("div",e,i),s=l.DomUtil.create("span","speed",t),n=l.DomUtil.create("div","slider",t),a=Math.round(1e4/(this._player.getTransitionTime()||1e3))/10;s.innerHTML=this._getDisplaySpeed(a);var o=new l.UI.Knob(n,{step:this.options.speedStep,rangeMin:this.options.minSpeed,rangeMax:this.options.maxSpeed});return o.on("dragend",function(e){var i=e.target.getValue();this._draggingSpeed=!1,s.innerHTML=this._getDisplaySpeed(i),this._sliderSpeedValueChanged(i)},this),o.on("drag",function(e){this._draggingSpeed=!0,s.innerHTML=this._getDisplaySpeed(e.target.getValue())},this),o.on("positionchanged",function(e){s.innerHTML=this._getDisplaySpeed(e.target.getValue())},this),l.DomEvent.on(n,"click",function(e){if(e.target!==o._element){var i=e.touches&&1===e.touches.length?e.touches[0]:e,t=l.DomEvent.getMousePosition(i,n).x;o.setPosition(t),s.innerHTML=this._getDisplaySpeed(o.getValue()),this._sliderSpeedValueChanged(o.getValue())}},this),o},_createSpeedMultiple:function(e,i,n){var t=l.DomUtil.create("div",e,i),a=l.DomUtil.create("span","speed",t),s=l.DomUtil.create("div","slider",t),o=Math.round(1e4/(this._player.getTransitionTime()||1e3))/10;a.innerHTML=this._getDisplaySpeed(o),a.style.display="none",s.style.display="none";var r=new l.UI.Knob(s,{step:this.options.speedStep,rangeMin:this.options.minSpeed,rangeMax:this.options.maxSpeed}),h=l.DomUtil.create("ul","speed-control",t);return n.map(function(i){var t=l.DomUtil.create("li","mulx"+i+(1==i?" active":""),h);t.textContent=i+"x";var s=this;t.addEventListener("click",function(){n.forEach(function(e){document.getElementsByClassName("mulx"+e)[0].classList.remove("active")}),t.classList.add("active");var e=s.options.speedMultiple?s.options.speedMultiple:1;a.innerHTML=s._getDisplaySpeed(i*e),s._sliderSpeedValueChanged(i*e)})},this),r},_buttonBackwardClicked:function(){this._timeDimension.previousTime(this._steps)},_buttonForwardClicked:function(){this._timeDimension.nextTime(this._steps)},_buttonLoopClicked:function(){this._player.setLooped(!this._player.isLooped())},_buttonPlayClicked:function(){this._player.isPlaying()?this._player.stop():this._player.start(this._steps)},_buttonPlayReverseClicked:function(){this._player.isPlaying()?this._player.stop():this._player.start(-1*this._steps)},_buttonDateClicked:function(){this._switchTimeZone()},_sliderTimeValueChanged:function(e){this._timeDimension.setCurrentTimeIndex(e)},_sliderLimitsValueChanged:function(e,i){this._timeDimension.setLowerLimitIndex(e),this._timeDimension.setUpperLimitIndex(i)},_sliderSpeedValueChanged:function(e){this._player.setTransitionTime(1e3/e)},_getCurrentTimeZone:function(){return this.options.timeZones[this._timeZoneIndex]},_switchTimeZone:function(){"utc"==this._getCurrentTimeZone().toLowerCase()&&l.DomUtil.removeClass(this._displayDate,"utc"),this._timeZoneIndex=(this._timeZoneIndex+1)%this.options.timeZones.length;var e=this._getCurrentTimeZone();"utc"==e.toLowerCase()?(l.DomUtil.addClass(this._displayDate,"utc"),this._displayDate.title="UTC Time"):"local"==e.toLowerCase()?this._displayDate.title="Local Time":this._displayDate.title=e,this._update()},_getDisplayDateFormat:function(e){var i=this._getCurrentTimeZone();return"utc"==i.toLowerCase()?e.toISOString():"local"==i.toLowerCase()?e.toLocaleString():e.toLocaleString([],{timeZone:i,timeZoneName:"short"})},_getDisplaySpeed:function(e){return e+"fps"},_getDisplayLoadingText:function(e,i){return"<span>"+Math.floor(e/i*100)+"%</span>"},_getDisplayNoTimeError:function(){return"Time not available"}}),l.Map.addInitHook(function(){this.options.timeDimensionControl&&(this.timeDimensionControl=l.control.timeDimension(this.options.timeDimensionControlOptions||{}),this.addControl(this.timeDimensionControl))}),l.control.timeDimension=function(e){return new l.Control.TimeDimension(e)},l.TimeDimension},window);